{"version":3,"file":"main.min.js","sources":["../src/main.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Main code to support true city profile field.\n *\n * @module     profilefield_truecity/main\n * @copyright  2025 David Herney @ BambuCo\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport $ from 'jquery';\nimport Modal from 'core/modal_save_cancel';\nimport ModalEvents from 'core/modal_events';\nimport Notification from 'core/notification';\nimport Log from 'core/log';\nimport {get_strings as getStrings} from 'core/str';\n\n/**\n * @type {jQuery|HTMLElement} Base container for the true city selector\n */\nvar $cotainerbase;\n\n/**\n * @type {jQuery|HTMLElement} Country select list element\n */\nvar $countrylist;\n\n/**\n * @type {jQuery|HTMLElement} Region select list element\n */\nvar $regionlist;\n\n/**\n * @type {jQuery|HTMLElement} City select list element\n */\nvar $citylist;\n\n/**\n * @type {jQuery|HTMLElement} Modal body container\n */\nvar $modalbody;\n\n/**\n * @type {string} Base URL for AJAX requests in order to fetch location data: countries, regions, and cities.\n */\nvar baseurl;\n\n/**\n * Strings to load from server.\n *\n * @type {Array}\n */\nvar strings = [\n    {key: 'invalidregionsdataformat', component: 'profilefield_truecity'},\n    {key: 'notset', component: 'profilefield_truecity'},\n    {key: 'selectacity', component: 'profilefield_truecity', },\n    {key: 'selectaregion', component: 'profilefield_truecity'},\n    {key: 'selectlocationtitle', component: 'profilefield_truecity'},\n    {key: 'locationtext', component: 'profilefield_truecity', param: {city: '[CITY]', country: '[COUNTRY]'}},\n    {key: 'failedtoloadcountrydata', component: 'profilefield_truecity'},\n    {key: 'failedtoloadregiondata', component: 'profilefield_truecity'},\n];\n\n/**\n * Loaded strings.\n *\n * @type {Array}\n */\nvar s = [];\n\n/**\n * Load strings from server.\n */\nasync function loadStrings() {\n    strings.forEach(one => {\n        s[one.key] = one.key;\n    });\n\n    getStrings(strings).then(function(results) {\n        var pos = 0;\n        strings.forEach(one => {\n            s[one.key] = results[pos];\n            pos++;\n        });\n        return true;\n    }).fail(function(e) {\n        Log.debug('Error loading strings');\n        Log.debug(e);\n    });\n}\n// End of Load strings.\n\n/**\n * Initialize module\n *\n * @param {string} uniqid Unique identifier for the field instance.\n * @param {string} url Base URL for AJAX requests in order to fetch location data: countries, regions, and cities.\n */\nexport const init = async (uniqid, url) => {\n    baseurl = url;\n\n    await loadStrings();\n\n    const selectorid = `#truecity-selector-${uniqid}`;\n    $cotainerbase = $(`${selectorid}`);\n    $countrylist = $(`${selectorid} select[name=\"profilefield_truecity_country\"]`);\n    $regionlist = $(`${selectorid} select[name=\"profilefield_truecity_region\"]`);\n    $citylist = $(`${selectorid} select[name=\"profilefield_truecity_city\"]`);\n\n    $modalbody = $cotainerbase.find('.modal-body');\n\n    var selectorModal;\n\n    // Create and show modal with the selector content\n    Modal.create({\n        title: s.selectlocationtitle,\n        body: `<div id=\"${selectorid.substring(1)}-modal\" class=\"truecity-selector-modal\"></div>`,\n    }).then(function(modal) {\n        selectorModal = modal;\n\n        // Add event listener for save button\n        modal.getRoot().on(ModalEvents.save, function() {\n            // Get selected values\n            const selectedCountry = $countrylist.val();\n            const selectedRegion = $regionlist.val();\n            const selectedCity = $citylist.val();\n\n            // Validate that all required values are selected.\n            if (!selectedCountry || !selectedRegion || !selectedCity) {\n                arguments[0].preventDefault();\n                $modalbody.find('.alert').remove();\n                $modalbody.prepend('<div class=\"alert alert-danger\" role=\"alert\">' + s.selectacity + '</div>');\n                return;\n            }\n\n            const countryName = $countrylist.find('option:selected').text();\n            const regionName = $regionlist.find('option:selected').text();\n            const cityName = $citylist.find('option:selected').text();\n\n            // Create JSON object with values and names\n            const locationData = {\n                country: {\n                    value: selectedCountry,\n                    name: countryName\n                },\n                region: {\n                    value: selectedRegion,\n                    name: regionName\n                },\n                city: {\n                    value: selectedCity,\n                    name: cityName\n                }\n            };\n\n            // Update location text display\n            const locationText = s.locationtext\n                .replace('[COUNTRY]', countryName)\n                .replace('[CITY]', cityName);\n\n            $cotainerbase.find('.truecity-information [data-locationtext]').text(locationText);\n\n            // Store JSON string in hidden input\n            const $hiddenInput = $('input[data-targetvalue=\"' + uniqid + '\"]');\n            $hiddenInput.val(JSON.stringify(locationData));\n\n            // Close modal after save\n            modal.hide();\n        });\n\n        return modal;\n    }).catch(Notification.exception);\n\n    $cotainerbase.find('.truecity-information [data-act=\"openselector\"]').on('click', function() {\n        selectorModal.show();\n        $(`${selectorid}-modal`).append($modalbody);\n        $modalbody.removeClass('hidden');\n    });\n\n    // Get the currently selected country.\n    const selectedCountry = $countrylist.val();\n    $countrylist.on('change', function() {\n        const countryCode = $(this).val();\n        $modalbody.find('.alert').remove();\n\n        // Deselect and clear region and city selects\n        deselectAutocompleteItems($regionlist);\n        deselectAutocompleteItems($citylist);\n        clearSelect($regionlist);\n        clearSelect($citylist);\n\n        if (countryCode && countryCode != '') {\n            loadCountryRegions(countryCode);\n        }\n    });\n\n    // If a country is selected, fetch its JSON data.\n    if (selectedCountry) {\n        loadCountryRegions(selectedCountry);\n    }\n};\n\n/**\n * Load regions for a given country.\n *\n * @param {string} countryCode The selected country code.\n */\nfunction loadCountryRegions(countryCode) {\n    const countryuri = `${baseurl}/countries`;\n    const countryJsonUrl = `${countryuri}/${countryCode}.json`;\n\n    $.ajax({\n        url: countryJsonUrl,\n        method: 'GET',\n        dataType: 'json',\n        success: function(data) {\n            if (Array.isArray(data)) {\n                // Handle the country data.\n                populateRegions(data);\n            } else {\n                Log.debug('profilefield_truecity', 'Invalid regions data format');\n                Notification.exception(new Error(s.invalidregionsdataformat));\n            }\n        },\n        error: function(xhr, status, error) {\n            Log.debug('profilefield_truecity', 'Error fetching country data: ' + error);\n            Notification.exception(new Error(s.failedtoloadcountrydata));\n        }\n    });\n}\n\n/**\n * Populate the regions dropdown based on the selected country.\n *\n * @param {Array} regions Array of region objects.\n */\nfunction populateRegions(regions) {\n    const $regionSelect = $regionlist;\n\n    // Deselect all options first\n    $regionSelect.find('option').prop('selected', false);\n\n    // Clear and repopulate the select\n    $regionSelect.empty();\n    $regionSelect.append('<option value=\"\"></option>');\n\n    regions = regions.sort((a, b) => a.n.localeCompare(b.n));\n    regions.forEach(region => {\n        $regionSelect.append(`<option value=\"${region.c}\">${region.n}</option>`);\n    });\n\n    // Set to empty value explicitly.\n    $regionSelect.val('');\n\n    // Trigger change event to update autocomplete UI.\n    $regionSelect.trigger('change');\n\n    // Get the currently selected region.\n    const selectedRegion = $regionSelect.val();\n\n    // Add event listener for region change (only once).\n    $regionSelect.off('change.truecity').on('change.truecity', function() {\n        const regionCode = $(this).val();\n        const countryCode = $countrylist.val();\n        $modalbody.find('.alert').remove();\n\n        deselectAutocompleteItems($citylist);\n        clearSelect($citylist);\n\n        if (regionCode && regionCode != '' && countryCode) {\n            loadRegionCities(countryCode, regionCode);\n        }\n    });\n\n    // If a region is already selected, load its cities.\n    if (selectedRegion && selectedRegion != '') {\n        const countryCode = $countrylist.val();\n        loadRegionCities(countryCode, selectedRegion);\n    }\n}\n\n/**\n * Load cities for a given country and region.\n *\n * @param {string} countryCode The selected country code.\n * @param {string} regionCode The selected region code.\n */\nfunction loadRegionCities(countryCode, regionCode) {\n    const regionuri = `${baseurl}/regions`;\n    const regionJsonUrl = `${regionuri}/${countryCode}_${regionCode}.json`;\n\n    $.ajax({\n        url: regionJsonUrl,\n        method: 'GET',\n        dataType: 'json',\n        success: function(data) {\n            if (Array.isArray(data)) {\n                // Handle the country data.\n                populateCities(data);\n            } else {\n                Log.debug('profilefield_truecity', 'Invalid cities data format');\n                Notification.exception(new Error(s.invalidregionsdataformat));\n            }\n        },\n        error: function(xhr, status, error) {\n            Log.debug('profilefield_truecity', 'Error fetching region data: ' + error);\n            Notification.exception(new Error(s.failedtoloadregiondata));\n        }\n    });\n}\n\n/**\n * Populate the cities dropdown based on the selected region.\n *\n * @param {Array} cities Array of city objects.\n */\nfunction populateCities(cities) {\n    // Deselect all options first\n    $citylist.find('option').prop('selected', false);\n\n    $citylist.empty();\n    $citylist.append('<option value=\"\"></option>');\n\n    cities = cities.sort((a, b) => a.n.localeCompare(b.n));\n    cities.forEach(city => {\n        $citylist.append(`<option value=\"${city.i}\">${city.n}</option>`);\n    });\n\n    // Set to empty value explicitly\n    $citylist.val('');\n\n    // Add event listener for city change (only once).\n    $citylist.off('change.truecity').on('change.truecity', function() {\n        $modalbody.find('.alert').remove();\n    });\n\n    // Trigger change event to update autocomplete UI\n    $citylist.trigger('change');\n}\n\n/**\n * Clear a select element and reset it to empty state.\n * Works with autocomplete-enhanced selects.\n *\n * @param {jQuery} $select The select element to clear.\n */\nfunction clearSelect($select) {\n    // First, deselect all options before removing them\n    $select.find('option').prop('selected', false);\n\n    // Now empty and add blank option\n    $select.empty();\n    $select.append('<option value=\"\"></option>');\n    $select.val('');\n\n    // Trigger change to update autocomplete UI\n    $select.trigger('change');\n}\n\n/**\n * Deselect all items in an autocomplete-enhanced select by clicking on the badges.\n * This properly triggers the autocomplete's deselection logic.\n *\n * @param {jQuery} $select The select element to deselect items from.\n */\nfunction deselectAutocompleteItems($select) {\n    // The autocomplete elements are added to the same container as the original select.\n    const $parent = $select.parent();\n\n    // Find the selection container (where the badges are shown).\n    // Class .form-autocomplete-selection is standard for Moodle autocomplete.\n    const $selectionContainer = $parent.find('.form-autocomplete-selection');\n\n    if (!$selectionContainer.length) {\n        return;\n    }\n\n    // Find all selected items (badges).\n    const $selectionItems = $selectionContainer.find('[role=\"option\"]');\n\n    // Click on each badge to trigger the deselection logic of the autocomplete component.\n    $selectionItems.each(function() {\n        $(this).trigger('click');\n    });\n\n    // Clear any remaining active value state on the container.\n    $selectionContainer.attr('data-active-value', '');\n}\n"],"names":["_interopRequireDefault","e","__esModule","default","$cotainerbase","$countrylist","$regionlist","$citylist","$modalbody","baseurl","_jquery","_modal_save_cancel","_modal_events","_notification","_log","strings","key","component","param","city","country","s","loadCountryRegions","countryCode","countryuri","concat","countryJsonUrl","$","ajax","url","method","dataType","success","data","Array","isArray","regions","$regionSelect","find","prop","empty","append","sort","a","b","n","localeCompare","forEach","region","c","val","trigger","selectedRegion","off","on","regionCode","this","remove","deselectAutocompleteItems","clearSelect","loadRegionCities","populateRegions","Log","debug","Notification","exception","Error","invalidregionsdataformat","error","xhr","status","failedtoloadcountrydata","regionuri","regionJsonUrl","cities","i","failedtoloadregiondata","$select","$selectionContainer","parent","length","each","attr","_exports","init","async","uniqid","one","getStrings","then","results","pos","fail","loadStrings","selectorid","selectorModal","Modal","create","title","selectlocationtitle","body","substring","modal","getRoot","ModalEvents","save","selectedCountry","selectedCity","arguments","preventDefault","prepend","selectacity","countryName","text","regionName","cityName","locationData","value","name","locationText","locationtext","replace","JSON","stringify","hide","catch","show","removeClass"],"mappings":"oOA0B2B,SAAAA,uBAAAC,GAAAA,OAAAA,GAAAA,EAAAC,WAAAD,EAAAE,CAAAA,QAAAF,EAAA;;;;;;;KAM3B,IAAIG,cAKAC,aAKAC,YAKAC,UAKAC,WAKAC,qFAnCJC,QAAAV,uBAAAU,SACAC,mBAAAX,uBAAAW,oBACAC,cAAAZ,uBAAAY,eACAC,cAAAb,uBAAAa,eACAC,KAAAd,uBAAAc,MAsCA,IAAIC,QAAU,CACV,CAACC,IAAK,2BAA4BC,UAAW,yBAC7C,CAACD,IAAK,SAAUC,UAAW,yBAC3B,CAACD,IAAK,cAAeC,UAAW,yBAChC,CAACD,IAAK,gBAAiBC,UAAW,yBAClC,CAACD,IAAK,sBAAuBC,UAAW,yBACxC,CAACD,IAAK,eAAgBC,UAAW,wBAAyBC,MAAO,CAACC,KAAM,SAAUC,QAAS,cAC3F,CAACJ,IAAK,0BAA2BC,UAAW,yBAC5C,CAACD,IAAK,yBAA0BC,UAAW,0BAQ3CI,EAAI,GA2IR,SAASC,mBAAmBC,aACxB,MAAMC,WAAU,GAAAC,OAAMhB,QAAmB,cACnCiB,kBAAcD,OAAMD,WAAUC,KAAAA,OAAIF,YAAkB,SAE1DI,QAACxB,QAACyB,KAAK,CACHC,IAAKH,eACLI,OAAQ,MACRC,SAAU,OACVC,QAAS,SAASC,MACVC,MAAMC,QAAQF,MAoB9B,SAAyBG,SACrB,MAAMC,cAAgB/B,YAGtB+B,cAAcC,KAAK,UAAUC,KAAK,YAAY,GAG9CF,cAAcG,QACdH,cAAcI,OAAO,+BAErBL,QAAUA,QAAQM,KAAK,CAACC,EAAGC,IAAMD,EAAEE,EAAEC,cAAcF,EAAEC,KAC7CE,QAAQC,SACZX,cAAcI,OAAMhB,kBAAAA,OAAmBuB,OAAOC,EAAC,MAAAxB,OAAKuB,OAAOH,kBAI/DR,cAAca,IAAI,IAGlBb,cAAcc,QAAQ,UAGtB,MAAMC,eAAiBf,cAAca,MAiBrC,GAdAb,cAAcgB,IAAI,mBAAmBC,GAAG,kBAAmB,WACvD,MAAMC,YAAa,EAAA5B,QAACxB,SAACqD,MAAMN,MACrB3B,YAAclB,aAAa6C,MACjC1C,WAAW8B,KAAK,UAAUmB,SAE1BC,0BAA0BnD,WAC1BoD,YAAYpD,WAERgD,YAA4B,IAAdA,YAAoBhC,aAClCqC,iBAAiBrC,YAAagC,WAEtC,GAGIH,gBAAoC,IAAlBA,eAAsB,CAExCQ,iBADoBvD,aAAa6C,MACHE,eAClC,CACJ,CA7DgBS,CAAgB5B,OAEhB6B,KAAAA,QAAIC,MAAM,wBAAyB,+BACnCC,cAAY7D,QAAC8D,UAAU,IAAIC,MAAM7C,EAAE8C,2BAE1C,EACDC,MAAO,SAASC,IAAKC,OAAQF,OACzBN,KAAG3D,QAAC4D,MAAM,wBAAyB,gCAAkCK,OACrEJ,cAAY7D,QAAC8D,UAAU,IAAIC,MAAM7C,EAAEkD,yBACvC,GAER,CA0DA,SAASX,iBAAiBrC,YAAagC,YACnC,MAAMiB,UAAS,GAAA/C,OAAMhB,QAAiB,YAChCgE,cAAa,GAAAhD,OAAM+C,UAAS,KAAA/C,OAAIF,YAAW,KAAAE,OAAI8B,WAAiB,SAEtE5B,QAACxB,QAACyB,KAAK,CACHC,IAAK4C,cACL3C,OAAQ,MACRC,SAAU,OACVC,QAAS,SAASC,MAqB1B,IAAwByC,OApBRxC,MAAMC,QAAQF,OAoBNyC,OAlBOzC,KAoB3B1B,UAAU+B,KAAK,UAAUC,KAAK,YAAY,GAE1ChC,UAAUiC,QACVjC,UAAUkC,OAAO,+BAEjBiC,OAASA,OAAOhC,KAAK,CAACC,EAAGC,IAAMD,EAAEE,EAAEC,cAAcF,EAAEC,KAC5CE,QAAQ5B,OACXZ,UAAUkC,OAAMhB,kBAAAA,OAAmBN,KAAKwD,EAAC,MAAAlD,OAAKN,KAAK0B,kBAIvDtC,UAAU2C,IAAI,IAGd3C,UAAU8C,IAAI,mBAAmBC,GAAG,kBAAmB,WACnD9C,WAAW8B,KAAK,UAAUmB,QAC9B,GAGAlD,UAAU4C,QAAQ,YArCNW,KAAAA,QAAIC,MAAM,wBAAyB,8BACnCC,cAAY7D,QAAC8D,UAAU,IAAIC,MAAM7C,EAAE8C,2BAE1C,EACDC,MAAO,SAASC,IAAKC,OAAQF,OACzBN,KAAG3D,QAAC4D,MAAM,wBAAyB,+BAAiCK,OACpEJ,cAAY7D,QAAC8D,UAAU,IAAIC,MAAM7C,EAAEuD,wBACvC,GAER,CAqCA,SAASjB,YAAYkB,SAEjBA,QAAQvC,KAAK,UAAUC,KAAK,YAAY,GAGxCsC,QAAQrC,QACRqC,QAAQpC,OAAO,8BACfoC,QAAQ3B,IAAI,IAGZ2B,QAAQ1B,QAAQ,SACpB,CAQA,SAASO,0BAA0BmB,SAE/B,MAIMC,oBAJUD,QAAQE,SAIYzC,KAAK,gCAEzC,IAAKwC,oBAAoBE,OACrB,OAIoBF,oBAAoBxC,KAAK,mBAGjC2C,KAAK,YACjB,EAAAtD,QAAAA,SAAE6B,MAAML,QAAQ,QACpB,GAGA2B,oBAAoBI,KAAK,oBAAqB,GAClD,CA3LEC,SAAAC,KAtGkBC,MAAOC,OAAQzD,OAC/BpB,QAAUoB,UA1BdwD,iBACItE,QAAQgC,QAAQwC,MACZlE,EAAEkE,IAAIvE,KAAOuE,IAAIvE,OAGrB,EAAAwE,KAAAA,aAAWzE,SAAS0E,KAAK,SAASC,SAC9B,IAAIC,IAAM,EAKV,OAJA5E,QAAQgC,QAAQwC,MACZlE,EAAEkE,IAAIvE,KAAO0E,QAAQC,KACrBA,SAEG,CACX,GAAGC,KAAK,SAAS3F,GACb6D,KAAAA,QAAIC,MAAM,yBACVD,KAAAA,QAAIC,MAAM9D,EACd,EACJ,CAYU4F,GAEN,MAAMC,WAAU,sBAAArE,OAAyB6D,QAQzC,IAAIS,cAPJ3F,eAAgB,EAAAuB,QAACxB,SAAA,GAAAsB,OAAIqE,aACrBzF,cAAe,EAAAsB,QAACxB,SAAA,GAAAsB,OAAIqE,6DACpBxF,aAAc,EAAAqB,QAACxB,SAAA,GAAAsB,OAAIqE,4DACnBvF,WAAY,EAAAoB,QAACxB,SAAA,GAAAsB,OAAIqE,0DAEjBtF,WAAaJ,cAAckC,KAAK,eAKhC0D,mBAAK7F,QAAC8F,OAAO,CACTC,MAAO7E,EAAE8E,oBACTC,KAAI,YAAA3E,OAAcqE,WAAWO,UAAU,GAAE,oDAC1CZ,KAAK,SAASa,OAqDb,OApDAP,cAAgBO,MAGhBA,MAAMC,UAAUjD,GAAGkD,cAAWrG,QAACsG,KAAM,WAEjC,MAAMC,gBAAkBrG,aAAa6C,MAC/BE,eAAiB9C,YAAY4C,MAC7ByD,aAAepG,UAAU2C,MAG/B,IAAKwD,kBAAoBtD,iBAAmBuD,aAIxC,OAHAC,UAAU,GAAGC,iBACbrG,WAAW8B,KAAK,UAAUmB,cAC1BjD,WAAWsG,QAAQ,gDAAkDzF,EAAE0F,YAAc,UAIzF,MAAMC,YAAc3G,aAAaiC,KAAK,mBAAmB2E,OACnDC,WAAa5G,YAAYgC,KAAK,mBAAmB2E,OACjDE,SAAW5G,UAAU+B,KAAK,mBAAmB2E,OAG7CG,aAAe,CACjBhG,QAAS,CACLiG,MAAOX,gBACPY,KAAMN,aAEVhE,OAAQ,CACJqE,MAAOjE,eACPkE,KAAMJ,YAEV/F,KAAM,CACFkG,MAAOV,aACPW,KAAMH,WAKRI,aAAelG,EAAEmG,aAClBC,QAAQ,YAAaT,aACrBS,QAAQ,SAAUN,UAEvB/G,cAAckC,KAAK,6CAA6C2E,KAAKM,eAGhD,EAAA5F,QAACxB,SAAC,2BAA6BmF,OAAS,MAChDpC,IAAIwE,KAAKC,UAAUP,eAGhCd,MAAMsB,MACV,GAEOtB,KACV,GAAEuB,MAAM7D,cAAY7D,QAAC8D,WAEtB7D,cAAckC,KAAK,mDAAmDgB,GAAG,QAAS,WAC9EyC,cAAc+B,QACd,EAAAnG,QAAAA,SAACF,GAAAA,OAAIqE,WAAkB,WAAErD,OAAOjC,YAChCA,WAAWuH,YAAY,SAC3B,GAGA,MAAMrB,gBAAkBrG,aAAa6C,MACrC7C,aAAaiD,GAAG,SAAU,WACtB,MAAM/B,aAAc,EAAAI,QAACxB,SAACqD,MAAMN,MAC5B1C,WAAW8B,KAAK,UAAUmB,SAG1BC,0BAA0BpD,aAC1BoD,0BAA0BnD,WAC1BoD,YAAYrD,aACZqD,YAAYpD,WAERgB,aAA8B,IAAfA,aACfD,mBAAmBC,YAE3B,GAGImF,iBACApF,mBAAmBoF,iBA6L1B"}