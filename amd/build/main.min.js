define("profilefield_truecity/main",["exports","jquery","core/modal_save_cancel","core/modal_events","core/notification","core/log","core/str"],function(_exports,_jquery,_modal_save_cancel,_modal_events,_notification,_log,_str){function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}
/**
   * Main code to support true city profile field.
   *
   * @module     profilefield_truecity/main
   * @copyright  2025 David Herney @ BambuCo
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */var $cotainerbase,$countrylist,$regionlist,$citylist,$modalbody;Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_jquery=_interopRequireDefault(_jquery),_modal_save_cancel=_interopRequireDefault(_modal_save_cancel),_modal_events=_interopRequireDefault(_modal_events),_notification=_interopRequireDefault(_notification),_log=_interopRequireDefault(_log);var baseurl,currentSelected=null,strings=[{key:"failedtoloadcountrydata",component:"profilefield_truecity"},{key:"failedtoloadregiondata",component:"profilefield_truecity"},{key:"invalidregionsdataformat",component:"profilefield_truecity"},{key:"locationtext",component:"profilefield_truecity",param:{city:"[CITY]",country:"[COUNTRY]"}},{key:"notset",component:"profilefield_truecity"},{key:"selectacity",component:"profilefield_truecity"},{key:"selectaregion",component:"profilefield_truecity"},{key:"selectlocationtitle",component:"profilefield_truecity"},{key:"unknownregion",component:"profilefield_truecity"}],s=[];function loadCountryRegions(countryCode){const countryuri="".concat(baseurl,"/countries"),countryJsonUrl="".concat(countryuri,"/").concat(countryCode,".json");_jquery.default.ajax({url:countryJsonUrl,method:"GET",dataType:"json",success:function(data){Array.isArray(data)?function(regions){$regionlist.find("option").prop("selected",!1),$regionlist.empty(),$regionlist.append('<option value=""></option>'),(regions=regions.sort((a,b)=>a.n.localeCompare(b.n))).forEach(region=>{let name=region.n;name&&""!==name.trim()&&"UNKNOWN"!=name||(name=s.unknownregion),$regionlist.append('<option value="'.concat(region.i,'">').concat(name,"</option>"))}),currentSelected&&currentSelected.region?($regionlist.val(currentSelected.region.value),currentSelected.region=null):$regionlist.val("");$regionlist.trigger("change");const selectedRegion=$regionlist.val();if($regionlist.off("change.truecity").on("change.truecity",function(){const regionCode=(0,_jquery.default)(this).val(),countryCode=$countrylist.val();$modalbody.find(".alert").remove(),deselectAutocompleteItems($citylist),clearSelect($citylist),regionCode&&""!=regionCode&&countryCode&&loadRegionCities(countryCode,regionCode)}),selectedRegion&&""!=selectedRegion){loadRegionCities($countrylist.val(),selectedRegion)}}(data):(_log.default.debug("profilefield_truecity","Invalid regions data format"),_notification.default.exception(new Error(s.invalidregionsdataformat)))},error:function(xhr,status,error){_log.default.debug("profilefield_truecity","Error fetching country data: "+error),_notification.default.exception(new Error(s.failedtoloadcountrydata))}})}function loadRegionCities(countryCode,regionCode){const regionuri="".concat(baseurl,"/regions"),regionJsonUrl="".concat(regionuri,"/").concat(countryCode,"_").concat(regionCode,".json");_jquery.default.ajax({url:regionJsonUrl,method:"GET",dataType:"json",success:function(data){Array.isArray(data)?function(cities){$citylist.find("option").prop("selected",!1),$citylist.empty(),$citylist.append('<option value=""></option>'),(cities=cities.sort((a,b)=>a.n.localeCompare(b.n))).forEach(city=>{$citylist.append('<option value="'.concat(city.i,'">').concat(city.n,"</option>"))}),currentSelected&&currentSelected.city?($citylist.val(currentSelected.city.value),currentSelected.city=null):$citylist.val("");$citylist.off("change.truecity").on("change.truecity",function(){$modalbody.find(".alert").remove()}),$citylist.trigger("change")}(data):(_log.default.debug("profilefield_truecity","Invalid cities data format"),_notification.default.exception(new Error(s.invalidregionsdataformat)))},error:function(xhr,status,error){_log.default.debug("profilefield_truecity","Error fetching region data: "+error),_notification.default.exception(new Error(s.failedtoloadregiondata))}})}function clearSelect($select){$select.find("option").prop("selected",!1),$select.empty(),$select.append('<option value=""></option>'),$select.val(""),$select.trigger("change")}function deselectAutocompleteItems($select){const $selectionContainer=$select.parent().find(".form-autocomplete-selection");if(!$selectionContainer.length)return;$selectionContainer.find('[role="option"]').each(function(){(0,_jquery.default)(this).trigger("click")}),$selectionContainer.attr("data-active-value","")}_exports.init=async(uniqid,url)=>{baseurl=url,await async function(){strings.forEach(one=>{s[one.key]=one.key}),await(0,_str.get_strings)(strings).then(function(results){var pos=0;return strings.forEach(one=>{console.log("Loaded string: "+one.key+" = "+results[pos]),s[one.key]=results[pos],pos++}),!0}).fail(function(e){_log.default.debug("Error loading strings"),_log.default.debug(e)})}();const selectorid="#truecity-selector-".concat(uniqid);$cotainerbase=(0,_jquery.default)("".concat(selectorid)),$countrylist=(0,_jquery.default)("".concat(selectorid,' select[name="profilefield_truecity_country"]')),$regionlist=(0,_jquery.default)("".concat(selectorid,' select[name="profilefield_truecity_region"]')),$citylist=(0,_jquery.default)("".concat(selectorid,' select[name="profilefield_truecity_city"]'));const $hiddenInput=(0,_jquery.default)('input[data-targetvalue="'+uniqid+'"]'),currentValue=$hiddenInput.val();if(currentValue)try{currentSelected=JSON.parse(currentValue)}catch(e){_log.default.debug("profilefield_truecity","Error parsing current location JSON: "+e)}var selectorModal;$modalbody=$cotainerbase.find(".modal-body"),console.log("Creating modal for truecity selector"),_modal_save_cancel.default.create({title:s.selectlocationtitle,body:'<div id="'.concat(selectorid.substring(1),'-modal" class="truecity-selector-modal"></div>')}).then(function(modal){return selectorModal=modal,modal.getRoot().on(_modal_events.default.save,function(){const selectedCountry=$countrylist.val(),selectedRegion=$regionlist.val(),selectedCity=$citylist.val();if(!selectedCountry||!selectedRegion||!selectedCity)return arguments[0].preventDefault(),$modalbody.find(".alert").remove(),void $modalbody.prepend('<div class="alert alert-danger" role="alert">'+s.selectacity+"</div>");const countryName=$countrylist.find("option:selected").text(),regionName=$regionlist.find("option:selected").text(),cityName=$citylist.find("option:selected").text(),locationData={country:{value:selectedCountry,name:countryName},region:{value:selectedRegion,name:regionName},city:{value:selectedCity,name:cityName}},locationText=s.locationtext.replace("[COUNTRY]",countryName).replace("[CITY]",cityName);$cotainerbase.find(".truecity-information [data-locationtext]").text(locationText),$hiddenInput.val(JSON.stringify(locationData)),modal.hide()}),modal}).catch(_notification.default.exception),$cotainerbase.find('.truecity-information [data-act="openselector"]').on("click",function(){selectorModal.show(),(0,_jquery.default)("".concat(selectorid,"-modal")).append($modalbody),$modalbody.removeClass("hidden")});const selectedCountry=$countrylist.val();$countrylist.on("change",function(){const countryCode=(0,_jquery.default)(this).val();$modalbody.find(".alert").remove(),deselectAutocompleteItems($regionlist),deselectAutocompleteItems($citylist),clearSelect($regionlist),clearSelect($citylist),countryCode&&""!=countryCode&&loadCountryRegions(countryCode)}),selectedCountry&&(currentSelected&&currentSelected.country&&currentSelected.country.value!==selectedCountry&&(currentSelected=null),loadCountryRegions(selectedCountry))}});

//# sourceMappingURL=main.min.js.map